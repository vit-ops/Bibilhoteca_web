<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='Admin.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='images/book_15028725.png') }}">
</head>
<body>
    <h2>Painel de Administração</h2>

    <div class="painel-superior">
        <!-- Formulário de registro -->
        <form method="POST" action="/registrar" class="formulario registro">
            <h3>Registrar Livro</h3>
            <input type="text" name="codigo" placeholder="Código do Livro" required>
            <input type="text" name="titulo" placeholder="Título do Livro" required>
            <input type="text" name="autor" placeholder="Autor do Livro" required>
            <button type="submit">Registrar Livro</button>
        </form>

        <!-- Formulário de busca -->
        <form method="POST" action="/admin" class="formulario busca">
            <h3>Buscar Livro</h3>
            <input type="text" name="busca" placeholder="Código, Título ou Autor" value="{{ busca }}">
            <button type="submit">Buscar</button>
        </form>
    </div>

    <h3>Livros Registrados</h3>
    <table>
        <thead>
            <tr>
                <th>Código</th>
                <th>Título</th>
                <th>Emprestado</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for livro in livros.values() %}
            <tr 
                data-autor="{{ livro['autor'] }}" 
                data-emprestado="{{ livro['emprestado'] }}" 
                data-nome="{{ livro['nome'] }}" 
                data-sala="{{ livro['sala'] }}" 
                data-data="{{ livro['data_emprestimo'] }}"
            >
                <td>{{ livro['codigo'] }}</td>
                <td>{{ livro['titulo'] }}</td>
                <td>{{ 'Sim' if livro['emprestado'] else 'Não' }}</td>
                <td>
                    {% if not livro['emprestado'] %}
                        <button class="emprestar-btn" data-codigo="{{ livro['codigo'] }}">Emprestar</button>
                    {% else %}
                        <button class="devolver-btn" 
                            data-codigo="{{ livro['codigo'] }}" 
                            data-nome="{{ livro['nome'] }}" 
                            data-sala="{{ livro['sala'] }}" 
                            data-data="{{ livro['data_emprestimo'] }}">Devolver</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Modal -->
    <div id="modal">
        <div class="content">
            <h3 id="modal-title"></h3>
            <p id="modal-codigo"></p>
            <p id="modal-autor"></p>
            <p id="modal-status"></p>
            <p id="modal-data"></p>
            <button id="modal-close">Fechar</button>
        </div>
    </div>

    <script>
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalCodigo = document.getElementById('modal-codigo');
        const modalAutor = document.getElementById('modal-autor');
        const modalStatus = document.getElementById('modal-status');
        const modalData = document.getElementById('modal-data');
        const modalClose = document.getElementById('modal-close');

        function abrirModal(livro) {
            modalTitle.textContent = livro.titulo;
            modalCodigo.textContent = "Código: " + livro.codigo;
            modalAutor.textContent = "Autor: " + livro.autor;
            if (livro.emprestado) {
                modalStatus.textContent = `Emprestado para: ${livro.nome}, Sala: ${livro.sala}`;
                modalData.textContent = `Data de Empréstimo: ${livro.data_emprestimo}`;
            } else {
                modalStatus.textContent = "Disponível";
                modalData.textContent = "";
            }
            modal.classList.add('show');
        }

        modalClose.addEventListener('click', () => modal.classList.remove('show'));
        modal.addEventListener('click', e => { if(e.target === modal) modal.classList.remove('show'); });

        document.querySelectorAll('table tbody tr').forEach(tr => {
            tr.addEventListener('click', () => {
                const livro = {
                    titulo: tr.children[1].textContent,
                    codigo: tr.children[0].textContent,
                    autor: tr.getAttribute('data-autor'),
                    emprestado: tr.getAttribute('data-emprestado') === 'True',
                    nome: tr.getAttribute('data-nome') || '',
                    sala: tr.getAttribute('data-sala') || '',
                    data_emprestimo: tr.getAttribute('data-data') || ''
                };
                abrirModal(livro);
            });
        });

        document.querySelectorAll('.emprestar-btn').forEach(button => {
            button.addEventListener('click', e => {
                e.stopPropagation();
                const codigo = button.getAttribute('data-codigo');
                const nome = prompt("Nome da pessoa:");
                const sala = prompt("Sala da pessoa:");
                const data_emprestimo = prompt("Data do Empréstimo (DD/MM/YYYY):");
                if(nome && sala && data_emprestimo){
                    fetch('/emprestar', {
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({codigo, nome, sala, data_emprestimo})
                    }).then(res => res.json()).then(data => {
                        alert(data.message || 'Erro desconhecido');
                        location.reload();
                    });
                } else {
                    alert("Nome, Sala e Data são obrigatórios!");
                }
            });
        });

        document.querySelectorAll('.devolver-btn').forEach(button => {
            button.addEventListener('click', e => {
                e.stopPropagation();
                const codigo = button.getAttribute('data-codigo');
                const nome = button.getAttribute('data-nome');
                const sala = button.getAttribute('data-sala');
                const data = button.getAttribute('data-data');
                const confirmar = confirm(`Livro emprestado para:\nNome: ${nome}\nSala: ${sala}\nData do Empréstimo: ${data}\n\nDeseja devolver?`);
                if(!confirmar) return;

                fetch('/devolver', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({codigo})
                }).then(res => res.json()).then(data => {
                    alert(data.message || 'Erro desconhecido');
                    location.reload();
                });
            });
        });
    </script>
</body>
</html>
